## 虎扑内容自动化视频制作发布系统 PRD
### 项目概述
1.1 项目背景
随着短视频快速发展，体育赛事相关的内容创作需求日益增长。本项目旨在开发一套自动化系统，通过无头浏览器从虎扑网站自动采集体育赛事相关内容，生成视频并自动发布到B站平台，实现内容生产的自动化和规模化。

1.2 项目目标
**自动化内容采集**：基于当日赛事日程，通过无头浏览器自动访问虎扑网站并采集相关内容
**智能视频生成**：将采集的文本、图片等内容生成流畅的视频内容
**无人值守发布**：自动将生成的视频上传至B站，实现全流程自动化
**提升内容产出效率**：减少人工操作，提高内容生产的时效性和规模

### 核心功能模块
2.1 任务调度模块
**功能描述**：作为系统的核心管家，负责统领全局，协调和管理整个视频生成任务的工作流程。

**核心能力**：
- 任务生命周期管理：创建、启动、暂停、恢复、取消任务
- 工作流编排：按照预设流程协调各模块执行顺序（采集→生成→发布）
- 任务状态监控：实时跟踪任务执行状态，记录各阶段进度
- 异常处理与重试：检测异常情况，自动触发重试机制或降级处理
- 任务队列管理：支持多任务排队执行，优先级调度
- 资源管理：监控系统资源使用情况，避免资源冲突
- 任务日志记录：完整记录任务执行过程，便于问题排查
- 定时任务调度：支持定时触发任务（如每日定时采集）

**工作流程控制**：
- 接收任务请求（定时触发或手动触发）
- 调用信息内容采集模块获取素材
- 调用视频生成模块生成视频
- 调用内容发布模块发布视频
- 记录任务执行结果和状态

2.2 信息内容采集模块
**功能描述**：负责操作无头浏览器访问虎扑网站，获取当前赛事的信息内容并保存起来。

**核心能力**：
- 无头浏览器管理：启动、配置和管理无头浏览器实例（Playwright/Selenium）
- 赛事日程获取：从虎扑网站爬取当日/近期赛事信息
- 智能页面导航：根据赛事类型（NBA、CBA、足球等）自动跳转到对应板块
- 内容页面识别：识别比赛详情页、新闻页、数据统计页等关键页面
- 多页面采集：按预设路径浏览多个相关页面（比赛前瞻、实时数据、赛后分析等）
- 内容提取：
  - 文本内容提取（比赛信息、数据统计、新闻内容等）
  - 图片内容下载（比赛截图、数据图表、球员照片等）
  - 视频链接提取（比赛集锦、精彩片段等）
- 数据清洗与结构化：将采集的原始内容转换为结构化数据
- 素材保存：将采集的内容保存到本地存储，并生成元数据
- 素材标记：为每个素材添加元数据（赛事名称、时间、页面类型、来源URL等）
- 采集策略配置：支持自定义采集路径、停留时间、重试次数等参数
- 反爬虫对抗：处理验证码、IP封禁等反爬虫机制

**采集内容类型**：
- 比赛实时数据（比分、统计、球员数据等）
- 比赛集锦视频链接
- 新闻资讯内容
- 球员/球队数据统计
- 用户评论热点内容
- 相关图片素材

2.3 视频生成模块
**功能描述**：负责将采集到的内容（文本、图片、视频链接等）生成完整的视频内容。

**核心能力**：
- 素材管理：统一管理文本、图片、视频片段、音频等各类素材文件
- 素材预处理：
  - 图片尺寸统一、格式转换、质量优化
  - 视频片段下载、裁剪、去重、格式标准化
  - 添加水印、Logo等品牌元素
  - 文本内容处理和格式化
- 视频合成：
  - 文本转视频：将文本内容转换为视频画面（如数据展示、新闻内容）
  - 图片转视频：将静态图片转换为动态视频片段
  - 多素材智能拼接（图片、视频片段、文本内容组合）
  - 添加转场效果（淡入淡出、滑动、缩放等）
  - 添加背景音乐或音效
  - 添加字幕和标题（赛事名称、时间、数据统计等）
  - 动态数据可视化：将统计数据转换为图表动画
- 视频后处理：
  - 分辨率统一（1080p/720p）
  - 帧率调整（30fps/60fps）
  - 视频压缩优化
  - 生成封面图
- 模板支持：支持多种视频模板（数据展示型、集锦型、资讯型等）
- 智能内容编排：根据采集的内容类型自动选择最佳模板和编排方式

**输出规格**：
- 视频格式：MP4（H.264编码）
- 分辨率：1920x1080或1280x720
- 时长：30秒-5分钟（可配置）
- 文件大小：根据B站上传限制优化

2.4 内容发布模块
**功能描述**：负责将生成好的视频发布到B站平台。

**核心能力**：
- B站账号管理：支持多账号管理，存储登录凭证（Cookie/Session）
- 自动登录：通过Selenium/Playwright模拟浏览器登录，处理验证码
- 视频上传：
  - 调用B站上传API或模拟网页上传流程
  - 支持断点续传，处理上传失败重试
  - 上传进度监控和日志记录
- 发布信息配置：
  - 自动生成标题（基于赛事信息）
  - 自动生成描述和标签
  - 设置分区、封面图等
  - 支持定时发布
- 发布状态跟踪：记录发布结果，处理发布失败情况
- 数据统计：记录视频播放量、点赞数等后续数据
- 发布结果通知：任务完成后通知任务调度模块

**发布策略**：
- 避免频繁发布触发平台限制
- 支持发布间隔配置
- 支持发布前人工审核模式（可选）

### 技术架构
3.1 技术栈选型
**任务调度**
- **APScheduler**：Python任务调度库，用于定时任务和任务编排
- **Celery**：分布式任务队列（可选，用于复杂场景）
- **asyncio**：异步任务处理，提高并发性能

**无头浏览器与网页爬取**
- **Playwright**：现代浏览器自动化框架，支持无头模式，推荐使用
- **Selenium**：传统浏览器自动化框架（备选方案）
- **requests**：HTTP请求库，用于API调用和简单网页请求
- **BeautifulSoup/lxml**：HTML解析库，用于内容提取
- **scrapy**：专业爬虫框架（可选，用于复杂爬取场景）

**视频处理**
- **FFmpeg**：强大的视频处理工具，用于视频合成、转码、裁剪
- **MoviePy**：Python视频编辑库，提供更友好的API接口
- **Pillow (PIL)**：图像处理库，用于图片处理和合成
- **opencv-python**：计算机视觉库，用于图像/视频处理
- **manim**：数学动画引擎（可选，用于数据可视化动画）

**内容发布**
- **Selenium/Playwright**：浏览器自动化框架，用于B站登录和上传
- **requests**：HTTP请求库，用于API调用
- **bilibili-api-python**：B站API封装库（如有可用版本）

**数据存储**
- **SQLite**：轻量级数据库，用于任务和素材记录
- **JSON文件**：配置文件和数据交换格式

**其他工具库**
- **loguru**：日志记录库
- **pydantic**：数据验证库
- **pyyaml**：YAML配置文件解析


3.2 技术架构图
┌─────────────────────────────────────────────────────────────┐
│                    任务调度模块（管家）                        │
│  (APScheduler/Celery - 任务编排、状态监控、异常处理)            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                              │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ 信息内容采集  │ 视频生成模块  │ 内容发布模块  │                  │
│   模块       │              │              │                  │
│ (无头浏览器)  │              │              │                  │
└──────────────┴──────────────┴──────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        基础设施层                              │
├──────────────┬──────────────┬──────────────┬─────────────────┤
│ Playwright/  │ FFmpeg/      │ HTTP Client/   │  SQLite/      │
│ Selenium     │ MoviePy      │ Selenium       │  JSON         │
└──────────────┴──────────────┴──────────────┴─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    外部依赖（虎扑网站、B站平台）                  │
└─────────────────────────────────────────────────────────────┘

3.3 数据流设计
```
┌─────────────┐
│  任务触发   │ (定时任务/手动触发)
└─────┬───────┘
      │
      ▼
┌─────────────────────────────────────┐
│  任务调度模块（管家）                 │
│  - 创建任务实例                       │
│  - 初始化任务配置                     │
│  - 启动工作流                         │
└─────┬───────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  1. 信息内容采集模块                  │
│  ┌──────────────────────────────┐   │
│  │ 启动无头浏览器                 │   │
│  │ → 访问虎扑网站                 │   │
│  │ → 获取赛事日程                 │   │
│  │ → 导航到目标页面               │   │
│  │ → 提取文本内容                 │   │
│  │ → 下载图片素材                 │   │
│  │ → 提取视频链接                 │   │
│  │ → 保存素材和元数据              │   │
│  └──────────────────────────────┘   │
│  (循环多个页面)                       │
└─────┬───────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  2. 素材整理与元数据                  │
│  - 素材文件分类存储                   │
│  - 生成素材清单（JSON/Metadata）      │
│  - 标记素材类型和来源                 │
└─────┬───────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  3. 视频生成模块                      │
│  ┌──────────────────────────────┐   │
│  │ 读取素材清单                  │   │
│  │ → 素材预处理（格式转换）       │   │
│  │ → 文本转视频                  │   │
│  │ → 图片转视频                  │   │
│  │ → 按模板组装视频              │   │
│  │ → 添加转场、字幕、音乐         │   │
│  │ → 视频渲染输出                │   │
│  │ → 生成封面图                  │   │
│  └──────────────────────────────┘   │
└─────┬───────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  4. 内容发布模块                      │
│  ┌──────────────────────────────┐   │
│  │ B站登录验证                   │   │
│  │ → 准备发布信息（标题、描述）   │   │
│  │ → 上传视频文件                │   │
│  │ → 设置发布参数                │   │
│  │ → 提交发布                    │   │
│  │ → 记录发布结果                │   │
│  └──────────────────────────────┘   │
└─────┬───────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────┐
│  5. 任务调度模块（收尾）              │
│  - 接收各模块执行结果                 │
│  - 更新任务状态                       │
│  - 清理临时文件                       │
│  - 生成任务报告                       │
└─────────────────────────────────────┘
```

### 工作流程
4.1 完整执行流程
1. **任务启动阶段（任务调度模块）**
   - 系统定时触发或手动启动任务
   - 检查系统资源（内存、磁盘空间等）
   - 加载配置参数（采集策略、视频模板、发布配置等）
   - 创建任务实例，初始化任务状态

2. **内容采集阶段（信息内容采集模块）**
   - 任务调度模块调用信息内容采集模块
   - 启动无头浏览器实例
   - 访问虎扑网站，获取当日赛事信息
   - 根据赛事类型导航到对应页面
   - 提取文本内容、下载图片、提取视频链接
   - 保存素材到本地存储，生成元数据
   - 返回采集结果给任务调度模块

3. **视频制作阶段（视频生成模块）**
   - 任务调度模块调用视频生成模块
   - 读取采集的素材清单
   - 素材预处理（格式转换、尺寸调整等）
   - 根据模板和素材类型生成视频
   - 添加字幕、转场、音乐等元素
   - 生成最终视频文件和封面
   - 返回视频文件路径给任务调度模块

4. **内容发布阶段（内容发布模块）**
   - 任务调度模块调用内容发布模块
   - 登录B站账号（如未登录）
   - 上传视频文件
   - 填写发布信息（标题、描述、标签等）
   - 提交发布
   - 记录发布状态和B站视频ID
   - 返回发布结果给任务调度模块

5. **任务收尾阶段（任务调度模块）**
   - 接收各模块的执行结果
   - 更新任务执行记录和状态
   - 清理临时文件
   - 生成执行报告
   - 通知任务完成

4.2 异常处理流程
- **无头浏览器启动失败**：重试3次，失败则跳过本次任务
- **网页访问超时**：跳过当前页面，继续下一个
- **内容提取失败**：记录错误日志，尝试备用提取方案
- **视频生成失败**：记录错误日志，保留原始素材，任务标记为失败
- **上传失败**：支持断点续传，失败后下次重试
- **网络异常**：等待网络恢复后继续执行
- **模块执行异常**：任务调度模块捕获异常，记录错误，决定是否重试或终止任务

### 数据模型设计
5.1 任务数据模型
```python
Task {
    task_id: str          # 任务唯一标识
    task_type: str        # 任务类型（采集/生成/发布）
    status: str           # 任务状态（pending/running/completed/failed）
    create_time: datetime # 创建时间
    start_time: datetime  # 开始时间
    end_time: datetime    # 结束时间
    config: dict         # 任务配置参数
    result: dict          # 任务执行结果
    error_msg: str        # 错误信息（如有）
}
```

5.2 素材数据模型
```python
Material {
    material_id: str      # 素材唯一标识
    task_id: str          # 关联任务ID
    material_type: str    # 素材类型（video/image/audio）
    file_path: str        # 文件路径
    file_size: int        # 文件大小（字节）
    duration: float       # 时长（秒，仅视频/音频）
    metadata: dict        # 元数据（赛事信息、页面类型等）
    create_time: datetime # 创建时间
}
```

5.3 视频数据模型
```python
Video {
    video_id: str         # 视频唯一标识
    task_id: str          # 关联任务ID
    file_path: str        # 视频文件路径
    file_size: int        # 文件大小
    duration: float       # 视频时长
    resolution: str       # 分辨率（如1920x1080）
    cover_path: str       # 封面图路径
    title: str            # 视频标题
    description: str      # 视频描述
    tags: list            # 标签列表
    create_time: datetime # 创建时间
    publish_status: str   # 发布状态（未发布/已发布/发布失败）
    bilibili_vid: str     # B站视频ID（发布后）
}
```

### 配置管理
6.1 系统配置
- **任务调度配置**：任务执行间隔、重试次数、并发数、超时时间
- **采集配置**：虎扑网站URL、采集路径、页面等待时间、重试次数、反爬虫策略
- **浏览器配置**：无头浏览器类型、窗口大小、User-Agent、代理设置
- **视频配置**：分辨率、帧率、编码参数、模板选择、输出路径
- **发布配置**：B站账号信息、发布间隔、默认分区、封面图设置

6.2 配置文件结构
```yaml
# config.yaml
scheduler:
  task_interval: 3600      # 任务执行间隔（秒）
  max_retry: 3             # 最大重试次数
  timeout: 1800            # 任务超时时间（秒）
  concurrent_tasks: 1      # 并发任务数
  
browser:
  type: "playwright"       # 浏览器类型：playwright/selenium
  headless: true           # 无头模式
  window_width: 1920
  window_height: 1080
  user_agent: "Mozilla/5.0..."
  proxy: null              # 代理设置（可选）
  
collection:
  base_url: "https://www.hupu.com"
  page_wait_time: 3.0      # 页面等待时间（秒）
  max_pages: 10            # 最大采集页面数
  retry_times: 3           # 重试次数
  anti_crawler:
    delay_range: [1, 3]    # 随机延迟范围（秒）
    use_proxy: false       # 是否使用代理
  
video:
  resolution: "1920x1080"
  fps: 30
  template: "default"
  output_dir: "./videos/final"
  
publish:
  account: "账号名"
  default_partition: "体育"
  publish_interval: 3600    # 发布间隔（秒）
  auto_publish: true       # 是否自动发布
```

### 存储设计
7.1 目录结构
```
project_root/
├── materials/          # 原始素材存储
│   ├── texts/         # 文本内容
│   ├── images/        # 图片素材
│   ├── videos/        # 视频片段
│   └── metadata/      # 素材元数据
├── videos/            # 生成的视频
│   ├── final/         # 最终视频
│   ├── covers/        # 封面图
│   └── temp/          # 临时文件
├── logs/              # 日志文件
├── config/            # 配置文件
└── database/          # 数据库文件（SQLite/JSON）
```

7.2 数据持久化
- **任务记录**：使用SQLite或JSON文件存储任务执行历史
- **素材索引**：维护素材清单，便于快速查找和管理
- **发布记录**：记录视频发布状态和B站视频ID

### 性能要求
8.1 执行效率
- 单次采集任务完成时间：< 20分钟
- 视频生成时间：< 10分钟（5分钟视频）
- 视频上传速度：根据网络带宽，支持断点续传
- 完整任务流程（采集+生成+发布）：< 40分钟

8.2 资源占用
- 内存占用：< 2GB
- 存储空间：单次任务素材+视频 < 5GB
- CPU占用：视频生成时 < 80%

8.3 稳定性要求
- 任务成功率：> 90%
- 系统连续运行时间：> 24小时
- 异常自动恢复能力

### 安全与合规
9.1 账号安全
- 登录凭证加密存储
- 支持多账号轮换，避免频繁操作
- 遵守B站平台使用规范

9.2 内容合规
- 视频内容符合B站社区规范
- 避免侵权内容
- 支持内容审核机制（可选）

9.3 数据安全
- 敏感信息加密存储
- 定期清理临时文件
- 日志脱敏处理

### 开发计划
10.1 开发阶段
**第一阶段：任务调度模块开发（1-2周）**
- 任务调度框架搭建
- 工作流编排功能
- 任务状态管理
- 异常处理和重试机制

**第二阶段：信息内容采集模块开发（2-3周）**
- 无头浏览器集成（Playwright/Selenium）
- 虎扑网站页面导航
- 内容提取功能（文本、图片、视频链接）
- 反爬虫对抗机制
- 素材保存和元数据管理

**第三阶段：视频生成模块开发（2-3周）**
- 视频合成引擎
- 文本转视频功能
- 图片转视频功能
- 模板系统
- 字幕和转场效果

**第四阶段：内容发布模块开发（1-2周）**
- B站登录和上传
- 发布信息自动填充
- 状态跟踪

**第五阶段：集成与优化（1-2周）**
- 模块间集成测试
- 异常处理完善
- 性能优化
- 完整端到端测试

10.2 技术难点
- **反爬虫对抗**：虎扑网站的反爬虫机制（验证码、IP封禁等）
- **页面结构变化**：虎扑网站更新导致元素定位失效
- **视频质量**：保证合成视频的流畅度和画质
- **B站风控机制**：避免频繁操作触发平台限制
- **任务调度复杂性**：多模块协调、异常恢复、状态管理

### 后续优化方向
11.1 功能扩展
- 支持多平台发布（抖音、快手等）
- AI自动生成视频标题和描述
- 智能素材筛选和排序
- 视频质量自动评估

11.2 技术优化
- 分布式任务执行（多实例并行）
- 视频生成加速（GPU加速）
- 智能重试策略
- 更完善的监控和告警
- 无头浏览器连接池管理
